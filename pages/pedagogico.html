<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <title>Pedagógico | ODIN OS</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

    <script>
        tailwind.config = { darkMode: 'class', theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'], }, colors: { dark: { 900: '#050507', 800: '#0E0E12', 700: '#1A1A23', 600: '#2A2A35' }, neon: { cyan: '#00F0FF', violet: '#7000FF', green: '#00FF94', red: '#FF003C', orange: '#F59E0B', pink: '#FF0080' } }, animation: { 'marquee': 'marquee 25s linear infinite', }, keyframes: { marquee: { '0%': { transform: 'translateX(100%)' }, '100%': { transform: 'translateX(-100%)' } } } } } }
    </script>
    <style>
        /* Replaced Tailwind @apply utilities with static CSS for browser usage */

        /* Glass panel appearance */
        .glass-panel {
            background-color: rgba(14, 14, 18, 0.6); /* dark-800/60 */
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            border: 1px solid #1A1A23; /* dark-700 */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
        }

        /* Input style used across the UI */
        .input-tech {
            width: 100%;
            background-color: #050507; /* dark-900 */
            border: 1px solid #2A2A35; /* dark-600 */
            border-radius: 0.375rem;
            padding: 0.75rem;
            color: #ffffff;
            font-family: 'JetBrains Mono', monospace;
            outline: none;
            font-size: 0.875rem; /* text-sm */
            transition: box-shadow .15s ease, border-color .15s ease;
        }
        .input-tech::placeholder {
            color: #6B7280; /* placeholder gray */
        }
        .input-tech:focus {
            border-color: #FF0080; /* neon-pink */
            box-shadow: 0 0 10px rgba(255, 0, 128, 0.2);
        }

        /* FullCalendar / UI tweaks */
        .fc {
            font-family: 'Inter', sans-serif;
            color: #d1d5db; /* text-gray-300 */
            --fc-border-color: #1A1A23;
            --fc-today-bg-color: rgba(255, 158, 11, 0.1);
        }
        .fc-toolbar-title {
            color: #ffffff;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            font-size: 0.875rem;
            font-weight: 700 !important;
        }
        .fc-button {
            background-color: #1A1A23; /* dark-700 */
            border: 1px solid #2A2A35; /* dark-600 */
            font-size: 0.75rem;
            text-transform: uppercase;
            font-weight: 700;
            padding: 0.25rem 0.5rem;
            color: #d1d5db !important;
            cursor: pointer !important;
            transition: background-color .15s ease, color .15s ease;
        }
        .fc-button:hover {
            background-color: #FF0080; /* neon-pink */
            color: #ffffff !important;
        }
        .fc-button-active {
            background-color: #FF0080 !important;
            border-color: #FF0080 !important;
            color: #ffffff !important;
        }

        /* Table builder */
        .table-builder th {
            font-size: 10px;
            text-transform: uppercase;
            color: #6B7280; /* gray-500 */
            font-weight: 700;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #1A1A23; /* border-dark-700 */
        }
        .table-builder td {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #0E0E12; /* border-dark-800 */
        }

        /* Page base */
        body {
            background-color: #050507; /* dark-900 */
            color: #d1d5db; /* text-gray-300 */
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    
    <div id="header-placeholder"></div>

    <div class="fixed top-24 left-0 w-full h-8 bg-dark-800 border-b border-dark-700 flex items-center overflow-hidden z-40 pointer-events-none">
        <div class="whitespace-nowrap animate-marquee text-xs font-mono flex gap-12" id="dynamic-ticker">
            <span class="text-gray-400">CRONOGRAMA 2025: <span class="text-neon-pink">ATIVO</span></span>
            <span class="text-gray-400">AULAS MENSAIS: <span class="text-neon-cyan">CONFIGURADO</span></span>
            <span class="text-gray-400">STATUS: <span class="text-neon-green">SISTEMA OPERANTE</span></span>
        </div>
    </div>

    <main class="flex-grow pt-40 px-6 container mx-auto pb-20">
        <div class="flex flex-col md:flex-row justify-between items-end mb-6 gap-4 border-b border-dark-700 pb-6">
            <div>
                <div class="flex items-center gap-2 text-neon-pink mb-2 font-mono text-xs tracking-widest uppercase">
                    <div class="w-2 h-2 bg-neon-pink rounded-full animate-pulse"></div> Gestão & Cronogramas
                </div>
                <h1 class="text-4xl md:text-5xl font-black text-white tracking-tight">
                    Pedagógico <span class="text-dark-700">/</span> Odin
                </h1>
            </div>
            
            <div class="flex gap-3">
                <a href="https://www.ircsystem.com.br/w2/index.php" target="_blank" class="bg-dark-800 border border-dark-600 text-white py-2 px-4 rounded hover:border-neon-pink transition text-xs uppercase tracking-widest flex items-center gap-2">
                    <i class="fas fa-external-link-alt"></i> IRC System
                </a>
                <button onclick="openClassBuilder()" class="bg-neon-pink text-white font-bold py-2 px-4 rounded hover:bg-pink-600 transition shadow-lg shadow-neon-pink/20 text-xs uppercase tracking-widest flex items-center gap-2">
                    <i class="fas fa-layer-group"></i> Criar Nova Turma
                </button>
                <button onclick="openEventModal()" class="bg-dark-800 border border-neon-pink text-neon-pink font-bold py-2 px-4 rounded hover:bg-neon-pink hover:text-white transition text-xs uppercase tracking-widest">
                    <i class="fas fa-calendar-plus"></i> Agenda
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-full">
            <div class="lg:col-span-9">
                <div class="glass-panel p-4 rounded-xl h-[700px]">
                    <div id='calendar' class="h-full"></div>
                </div>
            </div>

            <div class="lg:col-span-3 space-y-6">
                <div class="glass-panel rounded-xl overflow-hidden flex flex-col h-[400px]">
                    <div class="p-4 border-b border-dark-700 bg-dark-800/80 flex justify-between items-center">
                        <h3 class="text-white font-bold text-sm"><i class="far fa-clock mr-2 text-neon-cyan"></i> Agenda Recente</h3>
                    </div>
                    <div class="overflow-y-auto custom-scroll p-4 space-y-2" id="upcoming-list">
                        <p class="text-xs text-gray-500 text-center mt-4">Nenhum evento.</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="class-builder-modal" class="fixed inset-0 bg-black/95 backdrop-blur-md z-50 hidden flex items-center justify-center p-4 animate-[fadeIn_0.3s]">
        <div class="glass-panel rounded-2xl w-full max-w-6xl border border-neon-pink/30 relative flex flex-col h-[90vh]">
            <div class="p-6 border-b border-dark-700 flex justify-between items-center bg-dark-800/50 rounded-t-2xl">
                <div>
                    <h2 class="text-2xl font-bold text-white flex items-center"><i class="fas fa-cubes text-neon-pink mr-3"></i> Construtor de Cronograma IEFE</h2>
                    <p class="text-xs text-gray-400 mt-1">Defina a frequência mensal, horários e exporte o PDF oficial.</p>
                </div>
                <button onclick="closeClassBuilder()" class="text-gray-500 hover:text-white text-xl"><i class="fas fa-times"></i></button>
            </div>

            <div class="flex-grow overflow-hidden flex flex-col md:flex-row">
                <div class="w-full md:w-1/4 p-6 border-r border-dark-700 space-y-5 bg-dark-900/30 overflow-y-auto">
                    <div>
                        <label class="text-[10px] text-neon-pink uppercase font-bold block mb-1">1. Curso Base</label>
                        <select id="builder-template" class="input-tech cursor-pointer" onchange="loadTemplate()">
                            <option value="" disabled selected>Carregar Grade...</option>
                            <option value="pedagogia">Pedagogia</option>
                            <option value="neuro">Neuropsicopedagogia</option>
                            <option value="gestao">Gestão Escolar</option>
                            <option value="alfabetizacao">Alfabetização</option>
                            <option value="psicologia">Psicologia</option>
                            <option value="inclusiva">Ed. Inclusiva</option>
                        </select>
                    </div>
                    <div><label class="text-[10px] text-gray-500 uppercase font-bold block mb-1">2. Nome da Turma</label><input type="text" id="builder-name" class="input-tech border-l-4 border-l-neon-pink" placeholder="Ex: PÓS NEURO SÁBADO A25"></div>
                    <div><label class="text-[10px] text-gray-500 uppercase font-bold block mb-1">3. Horário</label><input type="text" id="builder-time" class="input-tech text-neon-cyan font-bold" placeholder="Ex: 08:00 às 17:00"></div>
                    
                    <div class="p-3 bg-dark-800 rounded border border-dark-600">
                        <h4 class="text-[10px] font-bold text-white uppercase mb-2"><i class="fas fa-calendar-alt mr-1"></i> Gerar Datas</h4>
                        <div class="space-y-2">
                            <div><label class="text-[10px] text-gray-500 block">Data Início</label><input type="date" id="builder-start" class="input-tech"></div>
                            <div><label class="text-[10px] text-gray-500 block">Frequência</label><select id="builder-freq" class="input-tech"><option value="monthly" selected>Mensal</option><option value="weekly">Semanal</option></select></div>
                            <button onclick="generateDates()" class="w-full bg-neon-cyan text-dark-900 text-xs font-bold py-2 rounded hover:bg-white transition">Aplicar</button>
                        </div>
                    </div>
                </div>
                <div class="w-full md:w-3/4 p-6 bg-dark-800/20 flex flex-col h-full">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-sm font-bold text-white uppercase tracking-wider">Grade Curricular</h3>
                        <div class="flex gap-2">
                            <button onclick="addSubjectRow()" class="text-xs bg-dark-700 hover:bg-white hover:text-dark-900 text-white px-3 py-1 rounded border border-gray-600 transition"><i class="fas fa-plus mr-1"></i> Add Aula</button>
                            <button onclick="exportPreviewPDF()" class="text-xs bg-neon-green hover:bg-white text-dark-900 px-4 py-1 rounded font-bold transition shadow-lg shadow-neon-green/20"><i class="fas fa-file-pdf mr-1"></i> PDF Preview</button>
                        </div>
                    </div>
                    <div class="overflow-y-auto custom-scroll flex-grow bg-dark-900/50 rounded-lg border border-dark-700">
                        <table class="w-full text-left table-builder">
                            <thead class="bg-dark-800 sticky top-0 z-10"><tr><th class="pl-4 w-10">#</th><th class="w-32">Data</th><th>Disciplina</th><th class="w-40 text-gray-600">Professor <i class="fas fa-eye-slash text-[8px]"></i></th><th class="w-10 text-center"></th></tr></thead>
                            <tbody id="builder-list"><tr><td colspan="5" class="text-center py-8 text-gray-600 italic">Selecione um curso...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-dark-700 bg-dark-800/80 rounded-b-2xl flex justify-end gap-3">
                <button onclick="closeClassBuilder()" class="px-6 py-2 rounded text-sm font-bold text-gray-400 hover:text-white transition">Fechar</button>
                <button onclick="saveClassToCalendar()" class="px-8 py-2 rounded bg-neon-pink text-white text-sm font-bold hover:bg-pink-600 transition shadow-lg shadow-neon-pink/20 flex items-center gap-2"><i class="fas fa-calendar-check"></i> Criar e Salvar</button>
            </div>
        </div>
    </div>

    <div id="event-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 animate-[fadeIn_0.2s]">
        <div class="glass-panel p-6 rounded-xl w-full max-w-md border border-dark-600 relative">
            <button onclick="closeEventModal()" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
            <h3 class="text-lg font-bold text-white mb-6 flex items-center gap-2">
                <i class="far fa-calendar-alt text-neon-pink"></i> <span id="modal-title">Detalhes</span>
            </h3>
            
            <input type="hidden" id="evt-id">
            <input type="hidden" id="evt-class-id"> 
            
            <div class="space-y-4">
                <div id="class-controls" class="hidden bg-dark-800/80 border border-neon-cyan/30 p-4 rounded-lg mb-4">
                    <h4 class="text-xs font-bold text-neon-cyan uppercase mb-2 flex items-center"><i class="fas fa-layer-group mr-2"></i> Gerenciar Turma</h4>
                    <p id="class-info-text" class="text-[10px] text-gray-400 mb-3">Este evento pertence a um cronograma completo.</p>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="downloadClassPDF()" class="bg-dark-900 hover:bg-neon-green hover:text-dark-900 text-white border border-dark-600 py-2 rounded text-[10px] font-bold transition flex items-center justify-center gap-1">
                            <i class="fas fa-file-pdf"></i> PDF Turma
                        </button>
                        <button onclick="deleteEntireClass()" class="bg-dark-900 hover:bg-red-500 hover:text-white text-red-500 border border-red-500/30 py-2 rounded text-[10px] font-bold transition flex items-center justify-center gap-1">
                            <i class="fas fa-trash"></i> Excluir Turma
                        </button>
                    </div>
                </div>

                <div><label class="text-[10px] text-gray-500 uppercase font-bold block mb-1">Título</label><input type="text" id="evt-title" class="input-tech font-bold"></div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="text-[10px] text-gray-500 uppercase font-bold block mb-1">Data</label><input type="date" id="evt-date" class="input-tech"></div>
                    <div><label class="text-[10px] text-gray-500 uppercase font-bold block mb-1">Cor</label><select id="evt-color" class="input-tech"><option value="#FF0080">Suporte</option><option value="#00F0FF">Reunião</option><option value="#00FF94">Aula</option></select></div>
                </div>
                <div class="flex gap-2 mt-4 pt-2 border-t border-dark-700">
                    <button onclick="saveEvent()" class="flex-1 bg-neon-pink text-white font-bold py-2 rounded hover:bg-pink-600 text-xs uppercase tracking-widest">Salvar Alteração</button>
                    <button onclick="deleteEvent()" id="btn-delete" class="hidden w-10 bg-dark-800 border border-red-500 text-red-500 rounded hover:bg-red-500 hover:text-white flex items-center justify-center"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast-container" class="fixed bottom-6 right-6 flex flex-col gap-3 z-50 pointer-events-none"></div>
    <div id="footer-placeholder"></div>
    
    <script type="module" src="../assets/js/main.js"></script>

    <script>
        // --- DADOS ---
        const courseTemplates = {
            'pedagogia': ["Didática Geral", "Psicologia da Educação", "História da Educação", "Sociologia da Educação", "Filosofia da Educação", "Libras", "Metodologia Científica", "Gestão Escolar", "Políticas Públicas", "Alfabetização", "Educação Inclusiva", "Estágio I", "Estágio II", "TCC I", "TCC II"],
            'neuro': ["Fundamentos da Neurociência", "Neuroanatomia", "Desenvolvimento Humano", "Bases Neurológicas", "Transtornos", "Psicofarmacologia", "Avaliação Neuro", "Intervenção Clínica", "Estágio"],
            'gestao': ["Legislação", "Gestão Democrática", "Planejamento", "Gestão de Pessoas", "Finanças", "Marketing Educacional", "Coordenação", "Tecnologias"]
        };

        let currentSubjects = [];
        let calendar;
        let events = [];
        const LS_KEY_AGENDA = 'ODIN_PEDAGOGICO_AGENDA';

        document.addEventListener('DOMContentLoaded', () => {
            loadEvents(); initCalendar(); updateTicker(); renderUpcomingList();
        });

        // --- CONSTRUTOR DE TURMAS ---
        function openClassBuilder() { document.getElementById('class-builder-modal').classList.remove('hidden'); }
        function closeClassBuilder() { document.getElementById('class-builder-modal').classList.add('hidden'); }

        function loadTemplate() {
            const type = document.getElementById('builder-template').value;
            if(courseTemplates[type]) {
                currentSubjects = courseTemplates[type].map(subj => ({ date: '', name: subj, prof: '' }));
                renderBuilderList();
                // Nome sug.
                const dayMap = {0:'DOM',1:'SEG',2:'TER',3:'QUA',4:'QUI',5:'SEX',6:'SAB'};
                const today = new Date().getDay();
                document.getElementById('builder-name').value = `${type.toUpperCase()} 2025`;
            }
        }

        function renderBuilderList() {
            const list = document.getElementById('builder-list');
            list.innerHTML = '';
            currentSubjects.forEach((subj, index) => {
                list.innerHTML += `<tr class="group hover:bg-dark-800 transition"><td class="pl-4 text-gray-500 font-mono text-xs">${index + 1}</td><td><input type="date" value="${subj.date}" class="bg-transparent border-b border-transparent focus:border-neon-pink w-full outline-none text-gray-300 text-xs py-1 font-mono" onchange="updateSubjectData(${index}, 'date', this.value)"></td><td><input type="text" value="${subj.name}" class="bg-transparent border-b border-transparent focus:border-neon-cyan w-full outline-none text-white text-sm py-1" onchange="updateSubjectData(${index}, 'name', this.value)"></td><td><input type="text" value="${subj.prof}" placeholder="Prof." class="bg-transparent border-b border-transparent focus:border-gray-500 w-full outline-none text-gray-500 text-xs py-1 italic" onchange="updateSubjectData(${index}, 'prof', this.value)"></td><td class="text-center"><button onclick="removeSubjectRow(${index})" class="text-gray-600 hover:text-red-500"><i class="fas fa-times"></i></button></td></tr>`;
            });
        }

        function updateSubjectData(idx, field, val) { currentSubjects[idx][field] = val; }
        function addSubjectRow() { currentSubjects.push({ date: '', name: "Nova Aula", prof: '' }); renderBuilderList(); }
        function removeSubjectRow(idx) { currentSubjects.splice(idx, 1); renderBuilderList(); }

        function generateDates() {
            const startVal = document.getElementById('builder-start').value;
            const freq = document.getElementById('builder-freq').value;
            if(!startVal) return showToast('Selecione data início', 'error');
            let currentDate = new Date(startVal + 'T00:00:00');
            currentSubjects.forEach((subj) => {
                subj.date = currentDate.toISOString().split('T')[0];
                if(freq === 'monthly') currentDate.setMonth(currentDate.getMonth() + 1);
                else currentDate.setDate(currentDate.getDate() + 7);
            });
            renderBuilderList();
            showToast('Datas geradas!', 'success');
        }

        // --- GERAÇÃO DE PDF CENTRALIZADA ---
        function generatePDF(className, classTime, subjects) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(22); doc.setTextColor(0, 0, 0);
            doc.text("Instituto Evolução Educacional - IEFE", 14, 20);
            doc.setLineWidth(0.5); doc.line(14, 25, 196, 25);
            doc.setFontSize(14); doc.text("CRONOGRAMA DE AULAS", 14, 35);
            doc.setFontSize(11); doc.setTextColor(80, 80, 80);
            doc.text(`TURMA: ${className.toUpperCase()}`, 14, 45);
            doc.text(`HORÁRIO: ${classTime.toUpperCase()}`, 14, 52);

            const tableBody = subjects.map(s => [ s.date ? s.date.split('-').reverse().join('/') : 'A definir', s.name ]);
            
            doc.autoTable({
                startY: 60,
                head: [['DATA', 'DISCIPLINA / MÓDULO']],
                body: tableBody,
                theme: 'striped',
                headStyles: { fillColor: [0, 0, 0], textColor: 255, fontStyle: 'bold' },
                styles: { fontSize: 10, cellPadding: 4 },
                columnStyles: { 0: { cellWidth: 50 } }
            });

            doc.setFontSize(8);
            doc.text(`Gerado em ${new Date().toLocaleDateString()}`, 14, doc.internal.pageSize.height - 10);
            doc.save(`Cronograma_${className.replace(/\s+/g, '_')}.pdf`);
        }

        // Preview no Builder
        function exportPreviewPDF() {
            const name = document.getElementById('builder-name').value || "Turma";
            const time = document.getElementById('builder-time').value || "A definir";
            generatePDF(name, time, currentSubjects);
            showToast('PDF Gerado!', 'success');
        }

        // Download da Agenda (Recuperado do Evento)
        function downloadClassPDF() {
            const classId = document.getElementById('evt-class-id').value;
            if(!classId) return;
            
            // Recupera todos os eventos dessa turma
            const classEvents = events.filter(e => e.extendedProps && e.extendedProps.classId === classId);
            if(classEvents.length === 0) return showToast('Erro ao recuperar turma', 'error');
            
            // Ordena por data
            classEvents.sort((a,b) => a.start.localeCompare(b.start));
            
            const meta = classEvents[0].extendedProps; // Pega metadados do primeiro
            const subjects = classEvents.map(e => ({
                date: e.start,
                name: e.extendedProps.subjectName || e.title
            }));
            
            generatePDF(meta.className, meta.classTime, subjects);
            showToast('PDF da turma baixado!', 'success');
        }

        function saveClassToCalendar() {
            const name = document.getElementById('builder-name').value;
            const time = document.getElementById('builder-time').value;
            const classId = 'CLASS-' + Date.now(); // ID Único para a turma

            let count = 0;
            currentSubjects.forEach(subj => {
                if(subj.date) {
                    const event = {
                        id: String(Date.now() + Math.random()),
                        title: `${name}: ${subj.name}`,
                        start: subj.date,
                        backgroundColor: '#00FF94',
                        borderColor: '#00FF94',
                        extendedProps: {
                            classId: classId,       // VÍNCULO
                            className: name,        // META
                            classTime: time,        // META
                            subjectName: subj.name  // NOME LIMPO
                        }
                    };
                    events.push(event);
                    calendar.addEvent(event);
                    count++;
                }
            });
            saveEventsToStorage(); closeClassBuilder(); showToast(`${count} aulas criadas!`, 'success');
        }
        
        // --- GESTÃO DE TURMAS (DELETE) ---
        function deleteEntireClass() {
            const classId = document.getElementById('evt-class-id').value;
            if(classId && confirm("ATENÇÃO: Isso apagará TODAS as aulas desta turma da agenda. Continuar?")) {
                // Remove do array local
                events = events.filter(e => !e.extendedProps || e.extendedProps.classId !== classId);
                // Remove do calendário visual
                calendar.getEvents().forEach(evt => {
                    if(evt.extendedProps.classId === classId) evt.remove();
                });
                
                saveEventsToStorage();
                closeEventModal();
                showToast('Turma completa excluída.', 'success');
            }
        }

        // --- AGENDA CORE ---
        function initCalendar() {
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,listMonth' },
                locale: 'pt-br', buttonText: { today: 'Hoje', month: 'Mês', list: 'Lista' },
                height: '100%', events: events,
                dateClick: (i) => openEventModal(null, i.dateStr),
                eventClick: (i) => openEventModal(i.event)
            });
            calendar.render();
        }

        function loadEvents() { const d = localStorage.getItem(LS_KEY_AGENDA); if(d) events = JSON.parse(d); }
        function saveEventsToStorage() { localStorage.setItem(LS_KEY_AGENDA, JSON.stringify(events)); updateTicker(); renderUpcomingList(); }
        
        function saveEvent() {
            // Salvar evento único (não turma)
            const id = document.getElementById('evt-id').value;
            const title = document.getElementById('evt-title').value;
            const date = document.getElementById('evt-date').value;
            const color = document.getElementById('evt-color').value;
            
            if(!title) return;

            if(id) {
                const e = calendar.getEventById(id);
                e.setProp('title',title); e.setStart(date); e.setProp('backgroundColor',color); e.setProp('borderColor',color);
                const idx = events.findIndex(ev=>ev.id===id); 
                if(idx>-1) {
                    // Mantém props se existirem
                    events[idx] = { ...events[idx], title, start:date, backgroundColor:color, borderColor:color };
                }
            } else {
                const n = {id:String(Date.now()), title, start:date, backgroundColor:color, borderColor:color};
                calendar.addEvent(n); events.push(n);
            }
            saveEventsToStorage(); closeEventModal(); showToast('Salvo','success');
        }
        
        function deleteEvent() {
            const id=document.getElementById('evt-id').value;
            if(id && confirm('Excluir evento único?')) {
                calendar.getEventById(id).remove();
                events=events.filter(e=>e.id!==id);
                saveEventsToStorage(); closeEventModal(); showToast('Excluído','info');
            }
        }

        // --- UI & MODALS ---
        function openEventModal(e=null, d=null) {
            const modal = document.getElementById('event-modal');
            const classControls = document.getElementById('class-controls');
            
            document.getElementById('event-modal').classList.remove('hidden');
            
            if(e) {
                // Editar
                document.getElementById('modal-title').innerText = 'Detalhes';
                document.getElementById('evt-id').value = e.id;
                document.getElementById('evt-title').value = e.title;
                document.getElementById('evt-date').value = e.startStr;
                document.getElementById('evt-color').value = e.backgroundColor;
                document.getElementById('btn-delete').classList.remove('hidden');
                
                // Verifica se é turma
                if (e.extendedProps && e.extendedProps.classId) {
                    classControls.classList.remove('hidden');
                    document.getElementById('evt-class-id').value = e.extendedProps.classId;
                    document.getElementById('class-info-text').innerText = `Turma: ${e.extendedProps.className}`;
                } else {
                    classControls.classList.add('hidden');
                    document.getElementById('evt-class-id').value = '';
                }

            } else {
                // Novo
                document.getElementById('modal-title').innerText = 'Novo Agendamento';
                document.getElementById('evt-id').value = '';
                document.getElementById('evt-title').value = '';
                document.getElementById('evt-date').value = d || '';
                document.getElementById('btn-delete').classList.add('hidden');
                classControls.classList.add('hidden');
            }
        }

        // Helper para abrir via ID (Lista Recente)
        window.openEventFromId = function(id) {
            const event = calendar.getEventById(id);
            if(event) openEventModal(event);
        }

        function renderUpcomingList() {
            const list = document.getElementById('upcoming-list'); list.innerHTML = '';
            const today = new Date().toISOString().split('T')[0];
            const upcoming = events.filter(e => e.start >= today).sort((a,b) => a.start.localeCompare(b.start)).slice(0, 10);
            if(upcoming.length === 0) list.innerHTML = '<p class="text-center text-gray-500 text-xs mt-4">Vazio.</p>';
            upcoming.forEach(e => {
                const d = e.start.split('-');
                list.innerHTML += `
                <div onclick="openEventFromId('${e.id}')" class="flex items-center justify-between p-2 bg-dark-900 rounded border border-dark-600 cursor-pointer hover:border-neon-cyan transition">
                    <div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full" style="background-color:${e.backgroundColor}"></div><span class="text-xs text-white truncate w-40 font-bold">${e.title}</span></div>
                    <span class="text-[10px] text-gray-500">${d[2]}/${d[1]}</span>
                </div>`;
            });
        }

        function updateTicker() { /* ... */ }
        function closeEventModal() { document.getElementById('event-modal').classList.add('hidden'); }
        function showToast(msg, type='info') { const c=document.getElementById('toast-container'); const t=document.createElement('div'); const cl=type==='success'?'border-neon-green text-neon-green':(type==='error'?'border-neon-red text-neon-red':'border-neon-pink text-neon-pink'); t.className=`pointer-events-auto bg-dark-800/95 backdrop-blur border-l-4 ${cl} text-white px-4 py-3 rounded shadow-lg animate-[fadeIn_0.3s]`; t.innerHTML=`<span class="font-bold text-sm">${msg}</span>`; c.appendChild(t); setTimeout(()=>{t.remove()},3000); }
    </script>
</body>
</html>